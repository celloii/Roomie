<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DormMatch - AI-Powered Campus Host Matching</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        textarea, input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        textarea:focus, input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .results.active {
            display: block;
        }

        .results h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .match-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .match-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .match-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }

        .match-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .match-score.high-score {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .match-score.medium-score {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .match-score.low-score {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .rank-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-size: 0.85em;
            font-weight: 700;
            margin-right: 10px;
            vertical-align: middle;
        }

        .match-id {
            margin-top: 10px;
            font-size: 0.85em;
            color: #999;
        }

        .raw-output {
            text-align: left;
            margin-top: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            color: #333;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .match-reasoning {
            color: #666;
            line-height: 1.6;
            margin-top: 10px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #c33;
        }

        .no-matches {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-matches-icon {
            font-size: 4em;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h1 style="margin: 0;">üè† DormMatch</h1>
                <div id="userInfo" style="display: none;">
                    <span id="userName" style="margin-right: 15px;"></span>
                    <button id="logoutBtn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">Logout</button>
                </div>
            </div>
            <p>AI-Powered Campus Host Matching</p>
        </div>
        
        <div class="content" id="authRequired" style="display: none;">
            <div style="text-align: center; padding: 40px;">
                <h2 style="color: #333; margin-bottom: 20px;">Authentication Required</h2>
                <p style="color: #666; margin-bottom: 30px;">Please log in as a visitor to find matches.</p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <a href="/login" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: 600;">Go to Login</a>
                    <a href="/host/dashboard" style="display: inline-block; background: rgba(102, 126, 234, 0.1); color: #667eea; padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: 600; border: 2px solid #667eea;">Are you a Host?</a>
                </div>
            </div>
        </div>
        
        <div class="content" id="mainContent">
            <form id="matchForm">
                <div class="form-group">
                    <label for="visitorQuery">Tell us about yourself and what you're looking for:</label>
                    <textarea 
                        id="visitorQuery" 
                        name="visitor_query" 
                        placeholder="e.g., I need a quiet place, I have classes early and go to bed by 10 PM. I'm a light sleeper and prefer a study-friendly environment."
                        required
                    ></textarea>
                </div>
                
                <div class="form-group">
                    <label for="dateNeeded">When do you need accommodation?</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input 
                            type="date" 
                            id="dateNeeded" 
                            name="date_needed" 
                            required
                            style="flex: 1;"
                        >
                        <span style="color: #666;">to</span>
                        <input 
                            type="date" 
                            id="dateNeededEnd" 
                            name="date_needed_end" 
                            style="flex: 1;"
                        >
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        Leave end date empty for single day, or select both for a date range
                    </small>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">
                    Find My Perfect Match üéØ
                </button>
            </form>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>AI is finding your perfect match...</p>
            </div>
            
            <div class="results" id="results">
                <h2>Your Matches</h2>
                <div id="matchesContainer"></div>
            </div>
            
            <div class="error" id="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('matchForm');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const matchesContainer = document.getElementById('matchesContainer');
        const errorDiv = document.getElementById('error');
        const authRequired = document.getElementById('authRequired');
        const mainContent = document.getElementById('mainContent');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');

        // Check authentication on load
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.authenticated || data.guest) {
                    // Authenticated or guest - show main content
                    mainContent.style.display = 'block';
                    authRequired.style.display = 'none';
                    
                    // Show user info if authenticated (not guest)
                    if (data.authenticated && data.user) {
                        userName.textContent = `üë§ ${data.user.name || data.user.email}`;
                        userInfo.style.display = 'block';
                    } else if (data.guest) {
                        // Guest user - show guest indicator
                        userName.textContent = 'üë§ Guest';
                        userInfo.style.display = 'block';
                    }
                    return true;
                } else {
                    // Not authenticated and not guest
                    mainContent.style.display = 'none';
                    authRequired.style.display = 'block';
                    return false;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                mainContent.style.display = 'none';
                authRequired.style.display = 'block';
                return false;
            }
        }

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        });

        // Initialize auth check
        checkAuth();

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateNeeded').setAttribute('min', today);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Reset UI
            errorDiv.style.display = 'none';
            results.classList.remove('active');
            loading.classList.add('active');
            submitBtn.disabled = true;
            matchesContainer.innerHTML = '';
            
            const startDate = document.getElementById('dateNeeded').value;
            const endDate = document.getElementById('dateNeededEnd').value;
            
            // Build date range string
            let dateNeeded = startDate;
            if (endDate && endDate !== startDate) {
                // Create comma-separated date range
                const start = new Date(startDate);
                const end = new Date(endDate);
                const dates = [];
                const current = new Date(start);
                while (current <= end) {
                    dates.push(current.toISOString().split('T')[0]);
                    current.setDate(current.getDate() + 1);
                }
                dateNeeded = dates.join(',');
            }
            
            const formData = {
                visitor_query: document.getElementById('visitorQuery').value,
                date_needed: dateNeeded
            };
            
            try {
                const response = await fetch('/api/match', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                loading.classList.remove('active');
                submitBtn.disabled = false;
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to get matches');
                }
                
                if (data.success && data.matches) {
                    displayMatches(data.matches);
                } else {
                    throw new Error('Unexpected response format');
                }
                
            } catch (error) {
                loading.classList.remove('active');
                submitBtn.disabled = false;
                errorDiv.textContent = `Error: ${error.message}`;
                errorDiv.style.display = 'block';
                console.error('Error:', error);
            }
        });
        
        function displayMatches(matches) {
            matchesContainer.innerHTML = '';
            
            // Handle different response formats
            let rankedMatches = [];
            
            // If we have raw_output, try to parse it
            if (matches.raw_output) {
                try {
                    // Try to extract JSON from the raw output
                    const jsonMatch = matches.raw_output.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const parsed = JSON.parse(jsonMatch[0]);
                        if (parsed.ranked_matches) {
                            rankedMatches = parsed.ranked_matches;
                        } else {
                            matches = parsed; // Replace matches with parsed version
                        }
                    } else {
                        // Show formatted raw output
                        matchesContainer.innerHTML = `
                            <div class="no-matches">
                                <div class="no-matches-icon">ü§ñ</div>
                                <p>AI Response:</p>
                                <div class="raw-output">${escapeHtml(matches.raw_output).replace(/\n/g, '<br>')}</div>
                            </div>
                        `;
                        results.classList.add('active');
                        return;
                    }
                } catch (e) {
                    // If parsing fails, show formatted output
                    matchesContainer.innerHTML = `
                        <div class="no-matches">
                            <div class="no-matches-icon">ü§ñ</div>
                            <p>AI Response:</p>
                            <div class="raw-output">${escapeHtml(matches.raw_output).replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                    results.classList.add('active');
                    return;
                }
            }
            
            // Check for ranked_matches in the matches object
            if (matches.ranked_matches && Array.isArray(matches.ranked_matches)) {
                rankedMatches = matches.ranked_matches;
            } else if (Array.isArray(matches)) {
                rankedMatches = matches;
            }
            
            if (rankedMatches.length === 0) {
                matchesContainer.innerHTML = `
                    <div class="no-matches">
                        <div class="no-matches-icon">üîç</div>
                        <p>No matches found for your criteria.</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">Try adjusting your preferences or date.</p>
                    </div>
                `;
            } else {
                rankedMatches.forEach((match, index) => {
                    const card = document.createElement('div');
                    card.className = 'match-card';
                    
                    const score = match.compatibility_score || match.score || 0;
                    const scorePercent = Math.round(score * 100);
                    const hostName = match.name || match.host_name || `Host ${match.host_id || index + 1}`;
                    const reasoning = match.reasoning || match.explanation || match.reason || '';
                    
                    // Color code based on score
                    let scoreClass = 'match-score';
                    if (scorePercent >= 80) scoreClass += ' high-score';
                    else if (scorePercent >= 60) scoreClass += ' medium-score';
                    else scoreClass += ' low-score';
                    
                    card.innerHTML = `
                        <div class="match-header">
                            <div class="match-name">
                                <span class="rank-badge">#${index + 1}</span>
                                <a href="/listing/${match.host_id || index + 1}" style="color: inherit; text-decoration: none;">${escapeHtml(hostName)}</a>
                            </div>
                            <div class="${scoreClass}">${scorePercent}% Match</div>
                        </div>
                        ${reasoning ? `<div class="match-reasoning">${escapeHtml(reasoning)}</div>` : ''}
                        ${match.host_id ? `<div class="match-id"><a href="/listing/${match.host_id}" style="color: #667eea; text-decoration: none; font-weight: 600;">View Listing ‚Üí</a></div>` : ''}
                    `;
                    
                    matchesContainer.appendChild(card);
                });
            }
            
            results.classList.add('active');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

